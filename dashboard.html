<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sari's Dashboard â€” Parent View</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Fredoka',sans-serif;background:#0D0A1A;color:#fff;min-height:100vh;padding:20px}
.ctr{max-width:820px;margin:0 auto}
h1{text-align:center;font-size:28px;margin-bottom:6px}
.sub{text-align:center;color:rgba(255,255,255,.4);font-size:14px;margin-bottom:32px}
.setup{background:rgba(255,255,255,.04);border:1.5px solid rgba(255,255,255,.1);border-radius:20px;padding:28px;text-align:center;margin-bottom:24px}
.setup input{width:100%;max-width:400px;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.12);border-radius:14px;padding:14px 16px;font-size:15px;color:#fff;font-family:'Fredoka',sans-serif;outline:none;margin:8px 0}
.setup button{background:linear-gradient(135deg,#FF3B8B,#FF6B8B);border:none;color:#fff;border-radius:14px;padding:14px 32px;font-size:16px;font-weight:600;cursor:pointer;font-family:'Fredoka',sans-serif;margin-top:12px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:14px;margin-bottom:24px}
.stat{background:linear-gradient(145deg,#2A1F3D,#1E1433);border-radius:20px;padding:18px;text-align:center;border:1px solid rgba(255,255,255,.06)}
.stat .ic{font-size:32px;margin-bottom:6px}
.stat .val{font-size:28px;font-weight:700;color:#FFD700}
.stat .lbl{font-size:12px;color:rgba(255,255,255,.4);margin-top:2px}
.sec{background:linear-gradient(145deg,#2A1F3D,#1E1433);border-radius:20px;padding:22px;margin-bottom:18px;border:1px solid rgba(255,255,255,.06)}
.sec h3{font-size:17px;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.bar-r{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.bar-l{width:90px;font-size:13px;color:rgba(255,255,255,.6);text-align:right}
.bar-t{flex:1;height:22px;background:rgba(255,255,255,.06);border-radius:11px;overflow:hidden}
.bar-f{height:100%;border-radius:11px;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:11px;font-weight:600;min-width:2px}
.bar-p{width:40px;font-size:13px;font-weight:600;color:rgba(255,255,255,.5)}
.sess{display:flex;align-items:center;gap:10px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.sess:last-child{border-bottom:none}
.sess .dt{font-size:13px;color:rgba(255,255,255,.5);width:85px}
.sess .sc{font-size:17px;font-weight:700;width:60px}
.sess .bd{flex:1;display:flex;gap:5px;flex-wrap:wrap}
.sess .bd .ch{font-size:11px;border-radius:7px;padding:3px 7px}
.tbl{width:100%;border-collapse:collapse;margin-top:10px}
.tbl th{text-align:left;font-size:12px;color:rgba(255,255,255,.4);padding:8px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:500}
.tbl td{font-size:14px;padding:8px;border-bottom:1px solid rgba(255,255,255,.03)}
.tbl .good{color:#00FF88}.tbl .bad{color:#FF6B6B}.tbl .mid{color:#FFD700}
.trend{display:flex;align-items:flex-end;gap:3px;height:110px;margin-top:10px}
.trend-b{flex:1;border-radius:5px 5px 0 0;min-height:3px;position:relative;cursor:pointer}
.trend-b:hover::after{content:attr(data-t);position:absolute;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);background:#2A1F3D;border:1px solid rgba(255,255,255,.15);border-radius:7px;padding:3px 7px;font-size:10px;white-space:nowrap}
.ref{background:none;border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.5);border-radius:10px;padding:8px 16px;font-size:13px;cursor:pointer;font-family:'Fredoka',sans-serif}
.tabs{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap}
.tab{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 16px;font-size:14px;cursor:pointer;font-family:'Fredoka',sans-serif;color:rgba(255,255,255,.5)}
.tab.on{background:rgba(255,59,139,.15);border-color:#FF3B8B;color:#FF3B8B}
@media(max-width:500px){.stats{grid-template-columns:1fr 1fr}.bar-l{width:65px;font-size:11px}}
</style>
</head>
<body>
<div class="ctr" id="app">
<h1>ğŸŒŸ Sari's Sound Quest</h1>
<p class="sub">Parent Dashboard</p>
<div id="ct"><div style="text-align:center;padding:60px;color:rgba(255,255,255,.4)">Loading...</div></div>
</div>
<script>
const PRIZES=[{s:10,e:"ğŸ•",n:"Pizza Night"},{s:20,e:"ğŸ“–",n:"Pizza Fish Story"},{s:35,e:"ğŸ¦",n:"Ice Cream Trip"},{s:50,e:"ğŸ“–",n:"Kira's Cloud Ride"},{s:65,e:"ğŸ¦„",n:"Unicorn Badge"},{s:75,e:"ğŸ¯",n:"DT Movie Night"},{s:85,e:"ğŸ“–",n:"Talia's First Word"},{s:100,e:"ğŸ‘‘",n:"Queen Crown"},{s:120,e:"ğŸ“–",n:"DT at School"},{s:140,e:"ğŸŒ­",n:"Hot Dog Party"},{s:160,e:"ğŸ“–",n:"Silly Hat Party"},{s:180,e:"ğŸŠâ€â™€ï¸",n:"Swim w/ Kira"},{s:200,e:"ğŸ“–",n:"Sari Mermaid"},{s:250,e:"ğŸ’",n:"Diamond Badge"},{s:300,e:"ğŸ’•",n:"Date w/ M&D"},{s:400,e:"ğŸ‚",n:"Mega Celebration"}];
let sb=null;const SU=localStorage.getItem("sq_dash_url")||"";const SK=localStorage.getItem("sq_dash_key")||"";
const $=id=>document.getElementById(id);const ct=$("ct");
let tabView="overview";

function showSetup(){
ct.innerHTML=`<div class="setup"><div style="font-size:48px;margin-bottom:16px">ğŸ“Š</div>
<h2 style="margin-bottom:8px">Connect to Database</h2>
<p style="color:rgba(255,255,255,.4);font-size:14px;margin-bottom:20px">Same Supabase credentials from the app's âš™ï¸ settings</p>
<input id="url" placeholder="Supabase Project URL" value="${SU}"><br>
<input id="key" placeholder="Supabase Anon Key" value="${SK}"><br>
<button onclick="doConnect()">Connect</button>
<div id="err" style="margin-top:12px;color:#FF6B6B;font-size:14px"></div></div>`}

async function doConnect(){
const u=$("url").value.trim(),k=$("key").value.trim();
if(!u||!k){$("err").textContent="Enter both";return}
$("err").textContent="Connecting...";
try{sb=window.supabase.createClient(u,k);
const{data,error}=await sb.from("progress").select("*").eq("player_id","sari").single();
if(error)throw error;localStorage.setItem("sq_dash_url",u);localStorage.setItem("sq_dash_key",k);loadAll()}
catch(e){$("err").textContent="âŒ Failed â€” check credentials or run SQL migration"}}

async function loadAll(){
ct.innerHTML='<div style="text-align:center;padding:40px;color:rgba(255,255,255,.4)">Loading data...</div>';
try{
const[{data:prog},{data:sessions},{data:answers}]=await Promise.all([
sb.from("progress").select("*").eq("player_id","sari").single(),
sb.from("sessions").select("*").eq("player_id","sari").order("created_at",{ascending:false}).limit(100),
sb.from("answers").select("*").eq("player_id","sari").order("created_at",{ascending:false}).limit(2000)
]);
if(!prog){ct.innerHTML='<div style="text-align:center;padding:60px;color:rgba(255,255,255,.4)">No data yet â€” Sari needs to complete a quest first!</div>';return}
render(prog,sessions||[],answers||[]);
}catch(e){ct.innerHTML='<div style="text-align:center;padding:60px;color:#FF6B6B">Error: '+e.message+'</div>'}}

function render(p,sessions,answers){
const real=sessions.filter(s=>!s.is_practice);
const avgPct=real.length?Math.round(real.reduce((a,s)=>a+s.total_correct,0)/real.length/20*100):0;
const gAvg=k=>real.length?Math.round(real.reduce((a,s)=>a+(s[k]||0),0)/real.length/5*100):0;
const games=[{n:"Sound Match",k:"sound_correct",a:gAvg("sound_correct"),c:"#FF3B8B",e:"ğŸ”Š"},
{n:"Rhyme Rocket",k:"rhyme_correct",a:gAvg("rhyme_correct"),c:"#B44BFF",e:"ğŸµ"},
{n:"Blend Blaster",k:"blend_correct",a:gAvg("blend_correct"),c:"#00C2FF",e:"ğŸš€"},
{n:"Word Builder",k:"build_correct",a:gAvg("build_correct"),c:"#FF9500",e:"ğŸ”¨"}];
const sorted=[...games].sort((a,b)=>b.a-a.a);
const nextPrize=PRIZES.find(pr=>pr.s>p.stars);
const trend=real.slice(0,20).reverse();

// Word accuracy
const wordMap={};const famMap={};const letterMap={};
answers.forEach(a=>{
if(a.target_word){if(!wordMap[a.target_word])wordMap[a.target_word]={w:a.target_word,ok:0,total:0};wordMap[a.target_word].total++;if(a.correct)wordMap[a.target_word].ok++}
if(a.word_family){if(!famMap[a.word_family])famMap[a.word_family]={f:a.word_family,ok:0,total:0};famMap[a.word_family].total++;if(a.correct)famMap[a.word_family].ok++}
if(a.target_letter&&a.game_mode==="sound"){if(!letterMap[a.target_letter])letterMap[a.target_letter]={l:a.target_letter,ok:0,total:0};letterMap[a.target_letter].total++;if(a.correct)letterMap[a.target_letter].ok++}
});
const words=Object.values(wordMap).filter(w=>w.total>=2).sort((a,b)=>(a.ok/a.total)-(b.ok/b.total));
const fams=Object.values(famMap).filter(f=>f.total>=3).sort((a,b)=>(a.ok/a.total)-(b.ok/b.total));
const letters=Object.values(letterMap).filter(l=>l.total>=2).sort((a,b)=>(a.ok/a.total)-(b.ok/b.total));

// Mistakes (wrong answers)
const mistakes=answers.filter(a=>!a.correct).slice(0,30);

let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px">
<div class="tabs">
<button class="tab ${tabView==='overview'?'on':''}" onclick="tabView='overview';loadAll()">ğŸ“Š Overview</button>
<button class="tab ${tabView==='words'?'on':''}" onclick="tabView='words';loadAll()">ğŸ“ Words</button>
<button class="tab ${tabView==='mistakes'?'on':''}" onclick="tabView='mistakes';loadAll()">âŒ Mistakes</button>
<button class="tab ${tabView==='sessions'?'on':''}" onclick="tabView='sessions';loadAll()">ğŸ“‹ Sessions</button>
</div>
<button class="ref" onclick="loadAll()">ğŸ”„</button></div>`;

if(tabView==='overview'){
html+=`
<div class="stats">
<div class="stat"><div class="ic">â­</div><div class="val">${p.stars}</div><div class="lbl">Stars</div></div>
<div class="stat"><div class="ic">ğŸ”¥</div><div class="val">${p.streak||0}</div><div class="lbl">Streak</div></div>
<div class="stat"><div class="ic">ğŸ“…</div><div class="val">${p.days_played||0}</div><div class="lbl">Days</div></div>
<div class="stat"><div class="ic">âœ…</div><div class="val">${p.correct||0}</div><div class="lbl">Correct</div></div>
<div class="stat"><div class="ic">ğŸ“Š</div><div class="val">${avgPct}%</div><div class="lbl">Avg Score</div></div>
<div class="stat"><div class="ic">ğŸ“</div><div class="val">${real.length}</div><div class="lbl">Quests</div></div>
</div>

${trend.length>1?`<div class="sec"><h3>ğŸ“ˆ Score Trend</h3>
<div class="trend">${trend.map(s=>{const h=Math.max(3,Math.round(s.total_correct/20*100));
return`<div class="trend-b" style="height:${h}%;background:linear-gradient(180deg,#FF3B8B,#B44BFF)" data-t="${s.session_date}: ${s.total_correct}/20 (${Math.round(s.total_correct/20*100)}%)"></div>`}).join("")}</div></div>`:""}

<div class="sec"><h3>ğŸ® Game Performance</h3>
${sorted.map(g=>`<div class="bar-r"><div class="bar-l">${g.e} ${g.n}</div><div class="bar-t"><div class="bar-f" style="width:${Math.max(2,g.a)}%;background:${g.c}">${g.a>15?g.a+"%":""}</div></div><div class="bar-p">${g.a}%</div></div>`).join("")}
<div style="margin-top:14px;padding:12px;background:rgba(255,255,255,.04);border-radius:14px;font-size:14px;line-height:1.5">
ğŸ’¡ ${sorted[0].a>0?`<strong style="color:${sorted[0].c}">${sorted[0].n}</strong> is strongest at ${sorted[0].a}%.`:"Not enough data."}
${sorted[3].a>0&&sorted[3].a<sorted[0].a?` <strong style="color:${sorted[3].c}">${sorted[3].n}</strong> needs practice at ${sorted[3].a}%.`:""}</div></div>

${fams.length?`<div class="sec"><h3>ğŸ”¤ Word Families</h3>
${fams.map(f=>{const pct=Math.round(f.ok/f.total*100);const c=pct>=80?"#00FF88":pct>=60?"#FFD700":"#FF6B6B";
return`<div class="bar-r"><div class="bar-l" style="font-weight:600">-${f.f}</div><div class="bar-t"><div class="bar-f" style="width:${Math.max(2,pct)}%;background:${c}">${pct>15?pct+"%":""}</div></div><div class="bar-p" style="color:${c}">${f.ok}/${f.total}</div></div>`}).join("")}</div>`:""}

${nextPrize?`<div class="sec"><h3>ğŸ Next Prize</h3>
<div style="display:flex;align-items:center;gap:14px">
<div style="font-size:44px">${nextPrize.e}</div>
<div style="flex:1"><div style="font-weight:600;margin-bottom:4px">${nextPrize.n}</div>
<div style="background:rgba(255,255,255,.08);border-radius:10px;height:14px;overflow:hidden"><div style="height:100%;border-radius:10px;background:linear-gradient(90deg,#FF3B8B,#FFD700);width:${Math.round(p.stars/nextPrize.s*100)}%"></div></div>
<div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:3px">${p.stars}/${nextPrize.s} stars</div></div></div></div>`:""}

${p.stickers&&p.stickers.length?`<div class="sec"><h3>âœ¨ Sticker Collection (${p.stickers.length})</h3>
<div style="display:flex;flex-wrap:wrap;gap:6px">${p.stickers.map(s=>`<span style="font-size:26px">${s}</span>`).join("")}</div></div>`:""}

<div class="sec"><h3>ğŸ† Prize Progress</h3>
<div style="display:flex;flex-wrap:wrap;gap:10px">${PRIZES.map(pr=>{const ok=p.stars>=pr.s;
return`<div style="display:flex;align-items:center;gap:6px;background:rgba(255,255,255,${ok?.04:.02});border:1px solid rgba(255,255,255,${ok?.1:.04});border-radius:12px;padding:8px 12px;opacity:${ok?1:.35}">
<span style="font-size:22px">${ok?pr.e:"ğŸ”’"}</span><span style="font-size:12px">${pr.n}<br><span style="color:rgba(255,255,255,.3)">${pr.s}â­</span></span></div>`}).join("")}</div></div>`;
}

if(tabView==='words'){
html+=`<div class="sec"><h3>ğŸ“ Word Accuracy (2+ attempts)</h3>
${words.length?`<table class="tbl"><tr><th>Word</th><th>Family</th><th>Correct</th><th>Total</th><th>Rate</th></tr>
${words.map(w=>{const pct=Math.round(w.ok/w.total*100);const cls=pct>=80?"good":pct>=60?"mid":"bad";
return`<tr><td style="font-weight:600;text-transform:uppercase">${w.w}</td><td>-${wordMap[w.w]?answers.find(a=>a.target_word===w.w)?.word_family||"?":"?"}</td><td>${w.ok}</td><td>${w.total}</td><td class="${cls}">${pct}%</td></tr>`}).join("")}</table>`:"<div style='color:rgba(255,255,255,.4);font-size:14px'>Not enough data yet</div>"}</div>

${letters.length?`<div class="sec"><h3>ğŸ”Š Letter Sound Accuracy</h3>
<table class="tbl"><tr><th>Letter</th><th>Correct</th><th>Total</th><th>Rate</th></tr>
${letters.map(l=>{const pct=Math.round(l.ok/l.total*100);const cls=pct>=80?"good":pct>=60?"mid":"bad";
return`<tr><td style="font-weight:700;font-size:18px;text-transform:uppercase">${l.l}</td><td>${l.ok}</td><td>${l.total}</td><td class="${cls}">${pct}%</td></tr>`}).join("")}</table></div>`:""}`}

if(tabView==='mistakes'){
html+=`<div class="sec"><h3>âŒ Recent Mistakes (learn from these!)</h3>
${mistakes.length?`<table class="tbl"><tr><th>Date</th><th>Game</th><th>Word</th><th>She Picked</th><th>Correct Was</th></tr>
${mistakes.map(a=>{const modeE=a.game_mode==="sound"?"ğŸ”Š":a.game_mode==="rhyme"?"ğŸµ":a.game_mode==="blend"?"ğŸš€":"ğŸ”¨";
return`<tr><td style="font-size:12px">${a.session_date}</td><td>${modeE}</td><td style="text-transform:uppercase;font-weight:600">${a.target_word||a.target_letter||"-"}</td><td class="bad" style="text-transform:uppercase">${a.user_answer||"-"}</td><td class="good" style="text-transform:uppercase">${a.correct_answer||"-"}</td></tr>`}).join("")}</table>`
:"<div style='color:rgba(255,255,255,.4);font-size:14px'>No mistakes yet! ğŸ‰</div>"}</div>

${words.filter(w=>Math.round(w.ok/w.total*100)<60).length?`<div class="sec"><h3>âš ï¸ Trouble Words (below 60%)</h3>
<div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px">
${words.filter(w=>Math.round(w.ok/w.total*100)<60).map(w=>`<div style="background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.3);border-radius:14px;padding:10px 16px;text-align:center">
<div style="font-size:20px;font-weight:700;text-transform:uppercase;color:#FF6B6B">${w.w}</div>
<div style="font-size:11px;color:rgba(255,255,255,.4)">${w.ok}/${w.total} (${Math.round(w.ok/w.total*100)}%)</div></div>`).join("")}
</div></div>`:""}`}

if(tabView==='sessions'){
html+=`<div class="sec"><h3>ğŸ“‹ All Sessions</h3>
${real.length?real.slice(0,25).map(s=>{const pct=Math.round(s.total_correct/20*100);const c=pct>=80?"#00FF88":pct>=60?"#FFD700":"#FF6B6B";
return`<div class="sess"><div class="dt">${s.session_date}</div><div class="sc" style="color:${c}">${s.total_correct}/20</div><div class="bd">
<span class="ch" style="background:rgba(255,59,139,.15);color:#FF3B8B">ğŸ”Š${s.sound_correct||0}/5</span>
<span class="ch" style="background:rgba(180,75,255,.15);color:#B44BFF">ğŸµ${s.rhyme_correct||0}/5</span>
<span class="ch" style="background:rgba(0,194,255,.15);color:#00C2FF">ğŸš€${s.blend_correct||0}/5</span>
<span class="ch" style="background:rgba(255,149,0,.15);color:#FF9500">ğŸ”¨${s.build_correct||0}/5</span>
</div><div style="font-size:12px;color:rgba(255,215,0,.6)">+${s.stars_earned}â­</div></div>`}).join("")
:"<div style='color:rgba(255,255,255,.4)'>No sessions yet</div>"}</div>`}

html+=`<div style="text-align:center;padding:16px;color:rgba(255,255,255,.12);font-size:11px">Updated: ${new Date().toLocaleString()}</div>`;
ct.innerHTML=html}

if(SU&&SK){sb=window.supabase.createClient(SU,SK);loadAll()}else showSetup();
</script>
</body>
</html>
